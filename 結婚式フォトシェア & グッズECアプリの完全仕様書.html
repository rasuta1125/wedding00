<!DOCTYPE html>
<html lang="ja" data-theme="light" style=""><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeddingMoments - å®Œå…¨é–‹ç™ºæŒ‡ç¤ºæ›¸</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        body {
            max-width: 880px;
            margin: 0 auto;
            padding: 32px 80px;
            position: relative;
            box-sizing: border-box;
            font-family: 'Noto Sans JP', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 20px;
            margin-bottom: 40px;
            font-size: 2.2em;
        }
        
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        
        h3 {
            color: #34495e;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        h4 {
            color: #2c3e50;
            margin-top: 25px;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        
        p {
            text-align: justify;
            margin-bottom: 15px;
        }
        
        ul, ol {
            margin-bottom: 15px;
            padding-left: 30px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e74c3c;
        }
        
        pre {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9em;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        
        .success {
            background-color: #d4edda;
            padding: 15px;
            border-left: 4px solid #28a745;
            margin: 20px 0;
        }
        
        .danger {
            background-color: #f8d7da;
            padding: 15px;
            border-left: 4px solid #dc3545;
            margin: 20px 0;
        }
        
        .info {
            background-color: #d1ecf1;
            padding: 15px;
            border-left: 4px solid #17a2b8;
            margin: 20px 0;
        }
        
        .toc {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin: 30px 0;
        }
        
        .toc ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .toc li {
            margin-bottom: 8px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.8em;
            font-weight: 600;
            border-radius: 4px;
            margin-right: 8px;
        }
        
        .badge-easy {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-hard {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .emoji {
            font-size: 1.2em;
        }
        
        blockquote {
            border-left: 4px solid #6c757d;
            padding-left: 20px;
            margin: 20px 0;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body style="">
    <h1>ğŸ“± WeddingMoments - å®Œå…¨é–‹ç™ºæŒ‡ç¤ºæ›¸</h1>

    <div class="info">
        <p><strong>ğŸ“… ä½œæˆæ—¥ï¼š</strong>2024å¹´11æœˆ18æ—¥</p>
        <p><strong>ğŸ¯ ç›®æ¨™ï¼š</strong>2025å¹´1æœˆæœ«ãƒªãƒªãƒ¼ã‚¹</p>
        <p><strong>ğŸ“ å¯¾è±¡ï¼š</strong>é–‹ç™ºè€…å‘ã‘æŠ€è¡“ä»•æ§˜æ›¸ï¼ˆå®Œå…¨ç‰ˆï¼‰</p>
    </div>

    <h2>ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦</h2>
    <p>æœ¬æŒ‡ç¤ºæ›¸ã¯ã€çµå©šå¼å†™çœŸå…±æœ‰ã‚¢ãƒ—ãƒªã€ŒWeddingMomentsã€ã«ã‚°ãƒƒã‚ºECæ©Ÿèƒ½ã‚’çµ±åˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Œå…¨é–‹ç™ºä»•æ§˜æ›¸ã§ã™ã€‚QRã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ç°¡å˜ã‚²ã‚¹ãƒˆå‚åŠ ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å†™çœŸå…±æœ‰ã€ãã®å ´ã§ã®ã‚¢ãƒ«ãƒãƒ æ³¨æ–‡æ©Ÿèƒ½ã«ã‚ˆã‚Šã€å¾“æ¥ã®å†™çœŸå…±æœ‰ã‚¢ãƒ—ãƒªã¨ã®å·®åˆ¥åŒ–ã‚’å›³ã‚Šã¾ã™ã€‚</p>

    <div class="toc">
        <h3>ğŸ“‹ ç›®æ¬¡</h3>
        <ol>
            <li>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä»•æ§˜</li>
            <li>æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°</li>
            <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆFirestoreï¼‰</li>
            <li>APIè¨­è¨ˆï¼ˆFirebase Functionsï¼‰</li>
            <li>iOS Appå®Ÿè£…è©³ç´°ï¼ˆSwiftUIï¼‰</li>
            <li>Web Appå®Ÿè£…ï¼ˆNext.js/Reactï¼‰</li>
            <li>Firebase Functionså®Ÿè£…</li>
            <li>Stripeæ±ºæ¸ˆå®Ÿè£…</li>
            <li>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</li>
            <li>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</li>
            <li>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</li>
            <li>ãƒ†ã‚¹ãƒˆè¨ˆç”»</li>
            <li>ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †</li>
            <li>ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚°</li>
            <li>é‹ç”¨ãƒ»ä¿å®ˆ</li>
            <li>ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š</li>
            <li>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</li>
            <li>ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</li>
            <li>è£œè¶³è³‡æ–™</li>
            <li>ã¾ã¨ã‚</li>
        </ol>
    </div>

    <h2>1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä»•æ§˜</h2>

    <h3>1.1 ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆæ¦‚è¦</h3>
    <ul>
        <li><strong>ã‚¢ãƒ—ãƒªåï¼š</strong>WeddingMomentsï¼ˆä»®ï¼‰</li>
        <li><strong>ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼š</strong>QRã‚³ãƒ¼ãƒ‰ã§ç°¡å˜å‚åŠ ã€ã‚²ã‚¹ãƒˆå…¨å“¡ãŒå†™çœŸå…±æœ‰ã€ãã®å ´ã§ã‚¢ãƒ«ãƒãƒ ç­‰ã‚’æ³¨æ–‡å¯èƒ½</li>
        <li><strong>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼š</strong>çµå©šå¼ã‚’æŒ™ã’ã‚‹ã‚«ãƒƒãƒ—ãƒ«ã€ã‚²ã‚¹ãƒˆ</li>
        <li><strong>å·®åˆ¥åŒ–ï¼š</strong>å†™çœŸå…±æœ‰ + ã‚°ãƒƒã‚ºECçµ±åˆ</li>
    </ul>

    <h3>1.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—å®šç¾©</h3>
    <ul>
        <li><strong>æ–°éƒæ–°å©¦ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ï¼š</strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¿…é ˆã€ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ»ç®¡ç†</li>
        <li><strong>ã‚²ã‚¹ãƒˆï¼š</strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸è¦ã€QRã‚¹ã‚­ãƒ£ãƒ³ã§ä¸€æ™‚å‚åŠ </li>
        <li><strong>ç®¡ç†è€…ï¼š</strong>ã‚°ãƒƒã‚ºç®¡ç†ã€æ³¨æ–‡ç®¡ç†</li>
    </ul>

    <h3>1.3 ã‚³ã‚¢æ©Ÿèƒ½ä¸€è¦§</h3>
    <ol>
        <li>ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ»ç®¡ç†ï¼ˆãƒ›ã‚¹ãƒˆï¼‰</li>
        <li>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»è¡¨ç¤º</li>
        <li>ã‚²ã‚¹ãƒˆå‚åŠ ï¼ˆç™»éŒ²ä¸è¦ï¼‰</li>
        <li>å†™çœŸæ’®å½±ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
        <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å†™çœŸãƒ•ã‚£ãƒ¼ãƒ‰</li>
        <li>ã‚¢ãƒ«ãƒãƒ ç®¡ç†ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
        <li>ã‚°ãƒƒã‚ºã‚«ã‚¿ãƒ­ã‚°</li>
        <li>ã‚«ãƒ¼ãƒˆãƒ»æ³¨æ–‡æ©Ÿèƒ½</li>
        <li>Stripeæ±ºæ¸ˆ</li>
        <li>æ³¨æ–‡ç®¡ç†ãƒ»é…é€è¿½è·¡</li>
    </ol>

    <h2>2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°</h2>

    <h3>2.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</h3>

    <h4>iOS Appï¼ˆæ–°éƒæ–°å©¦ç”¨ï¼‰</h4>
    <ul>
        <li>è¨€èª: Swift 5.9+</li>
        <li>UI Framework: SwiftUI</li>
        <li>æœ€å°å¯¾å¿œ: iOS 15.6</li>
        <li>ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼: Swift Package Manager</li>
        <li>ä¸»è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒª:
            <ul>
                <li>Firebase iOS SDK</li>
                <li>StripePayments-iOS</li>
                <li>Kingfisherï¼ˆç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ï¼‰</li>
                <li>CodeScannerï¼ˆQRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼‰</li>
            </ul>
        </li>
    </ul>

    <h4>Web Appï¼ˆã‚²ã‚¹ãƒˆç”¨ï¼‰</h4>
    <ul>
        <li>Framework: Next.js 14 (React 18)</li>
        <li>è¨€èª: TypeScript</li>
        <li>ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°: Tailwind CSS</li>
        <li>PWAå¯¾å¿œ: next-pwa</li>
        <li>ä¸»è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒª:
            <ul>
                <li>Firebase JS SDK</li>
                <li>@stripe/stripe-js</li>
                <li>react-qr-scanner</li>
                <li>react-image-crop</li>
            </ul>
        </li>
    </ul>

    <h3>2.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</h3>

    <h4>Firebase Services</h4>
    <ul>
        <li>Authentication: Apple Sign In, Google Sign In</li>
        <li>Firestore: NoSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</li>
        <li>Storage: å†™çœŸãƒ»ç”»åƒä¿å­˜</li>
        <li>Functions: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆNode.js 18ï¼‰</li>
        <li>Hosting: Web Appé…ä¿¡</li>
        <li>Cloud Messaging: ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥</li>
    </ul>

    <h4>ãã®ä»–ã‚µãƒ¼ãƒ“ã‚¹</h4>
    <ul>
        <li>Stripe: æ±ºæ¸ˆå‡¦ç†</li>
        <li>SendGrid: ãƒ¡ãƒ¼ãƒ«é€ä¿¡</li>
        <li>ImageKit/Cloudinary: ç”»åƒæœ€é©åŒ–ãƒ»CDN</li>
    </ul>

    <h3>2.3 é–‹ç™ºç’°å¢ƒ</h3>
    <ul>
        <li>Xcode 15.0+</li>
        <li>Node.js 18+</li>
        <li>Git/GitHub</li>
        <li>Firebase CLI</li>
        <li>Stripe CLIï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰</li>
    </ul>

    <h2>3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆFirestoreï¼‰</h2>

    <h3>3.1 Collectionsæ§‹é€ </h3>

    <h4>users - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h4>
    <pre>{
  userId: string, // Auto-generated
  email: string,
  displayName: string,
  photoURL: string | null,
  provider: "apple" | "google",
  createdAt: Timestamp,
  updatedAt: Timestamp
}</pre>

    <h4>events - ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±</h4>
    <pre>{
  eventId: string, // Auto-generated
  hostUserId: string, // users.userIdå‚ç…§
  eventName: string, // "å±±ç”°å¤ªéƒ &amp; èŠ±å­ çµå©šå¼"
  eventDate: string, // ISO 8601 "2025-01-25"
  eventLocation: string | null,
  qrToken: string, // æš—å·åŒ–ã•ã‚ŒãŸä¸€æ„ãƒˆãƒ¼ã‚¯ãƒ³
  qrCodeUrl: string, // ç”Ÿæˆã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã®URL
  guestLimit: number, // 25, 50, 100, 175, 250
  currentGuestCount: number, // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ã‚¦ãƒ³ãƒˆ
  status: "draft" | "active" | "ended" | "archived",
  photosPublishedAt: Timestamp | null, // å†™çœŸå…¬é–‹æ—¥æ™‚
  autoPublish: boolean, // ç¿Œæ—¥è‡ªå‹•å…¬é–‹
  publishTime: string, // "09:00" HH:mm format
  settings: {
    allowGuestDownload: boolean,
    watermark: boolean,
    compressionQuality: number // 0.1-1.0
  },
  subscriptionTier: "basic" | "standard" | "premium",
  stripeSubscriptionId: string | null,
  createdAt: Timestamp,
  updatedAt: Timestamp
}</pre>

    <h4>guestSessions - ã‚²ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆä¸€æ™‚çš„ï¼‰</h4>
    <pre>{
  sessionId: string, // Auto-generated
  eventId: string, // events.eventIdå‚ç…§
  guestToken: string, // ä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³
  deviceInfo: string, // User-Agentç­‰
  ipAddress: string,
  expiresAt: Timestamp, // ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†å¾Œ7æ—¥
  lastAccessAt: Timestamp,
  createdAt: Timestamp
}</pre>

    <h4>photos - å†™çœŸæƒ…å ±</h4>
    <pre>{
  photoId: string, // Auto-generated
  eventId: string, // events.eventIdå‚ç…§
  uploadedBy: string, // hostUserId or guestToken
  uploaderType: "host" | "guest",
  originalUrl: string, // Firebase Storage URL
  thumbnailUrl: string, // 200x200
  mediumUrl: string, // 800x800
  imageMetadata: {
    width: number,
    height: number,
    size: number, // bytes
    format: string, // "jpg", "png", "heic"
    exif: object | null
  },
  isPublished: boolean, // å…¬é–‹ãƒ•ãƒ©ã‚°
  uploadedAt: Timestamp,
  publishedAt: Timestamp | null
}</pre>

    <h4>products - ã‚°ãƒƒã‚ºå•†å“</h4>
    <pre>{
  productId: string, // Auto-generated
  name: string, // "ãƒ•ã‚©ãƒˆã‚¢ãƒ«ãƒãƒ ï¼ˆA4ã‚µã‚¤ã‚ºï¼‰"
  description: string,
  category: "album" | "frame" | "keychain" | "mug" | "calendar" | "card",
  basePrice: number, // å††ï¼ˆç¨è¾¼ï¼‰
  images: string[], // å•†å“ç”»åƒURLé…åˆ—
  options: [{
    optionId: string,
    name: string, // "ã‚µã‚¤ã‚º"
    values: [{value: "A4", priceModifier: 0}]
  }],
  stockQuantity: number | null, // null = å—æ³¨ç”Ÿç”£
  isActive: boolean,
  sortOrder: number,
  createdAt: Timestamp,
  updatedAt: Timestamp
}</pre>

    <h4>orders - æ³¨æ–‡æƒ…å ±</h4>
    <pre>{
  orderId: string, // Auto-generated
  eventId: string, // events.eventIdå‚ç…§
  orderNumber: string, // "WM20250125-001"
  items: [{
    productId: string,
    productName: string,
    quantity: number,
    unitPrice: number,
    selectedOptions: [{optionId: string, value: string}],
    subtotal: number
  }],
  shippingInfo: {
    name: string,
    email: string,
    phone: string,
    postalCode: string,
    prefecture: string,
    city: string,
    address1: string,
    address2: string | null
  },
  amounts: {
    subtotal: number,
    tax: number,
    shipping: number,
    total: number
  },
  payment: {
    method: "stripe",
    stripePaymentIntentId: string,
    stripeChargeId: string | null,
    paidAt: Timestamp | null
  },
  status: "pending" | "paid" | "processing" | "shipped" | "delivered" | "cancelled",
  trackingNumber: string | null,
  shippedAt: Timestamp | null,
  deliveredAt: Timestamp | null,
  notes: string | null,
  createdAt: Timestamp,
  updatedAt: Timestamp
}</pre>

    <h3>3.2 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®š</h3>
    <p>Firestoreã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆï¼š</p>
    <ul>
        <li>events: (hostUserId, status)</li>
        <li>photos: (eventId, uploadedAt)</li>
        <li>photos: (eventId, isPublished, uploadedAt)</li>
        <li>orders: (eventId, status)</li>
        <li>guestSessions: (eventId, expiresAt)</li>
    </ul>

    <h3>3.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«</h3>
    <pre>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() &amp;&amp; request.auth.uid == userId;
    }
    
    function hasValidGuestToken(eventId) {
      return request.auth.token.eventId == eventId;
    }
    
    // Users
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Events
    match /events/{eventId} {
      allow read: if isAuthenticated() || hasValidGuestToken(eventId);
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.hostUserId);
    }
    
    // Photos
    match /photos/{photoId} {
      allow read: if hasValidGuestToken(resource.data.eventId) || 
                     isAuthenticated();
      allow create: if hasValidGuestToken(request.resource.data.eventId) ||
                       isAuthenticated();
      allow update, delete: if isOwner(resource.data.eventId);
    }
    
    // Products
    match /products/{productId} {
      allow read: if true; // Public
      allow write: if false; // Admin only (via Functions)
    }
    
    // Orders
    match /orders/{orderId} {
      allow read: if isAuthenticated() || 
                     request.auth.token.email == resource.data.shippingInfo.email;
      allow create: if true; // Anyone can create (validated in Function)
      allow update: if false; // Only via Functions
    }
  }
}</pre>

    <h2>4. APIè¨­è¨ˆï¼ˆFirebase Functionsï¼‰</h2>

    <h3>4.1 èªè¨¼é–¢é€£</h3>
    <h4>POST /api/auth/createHostAccount</h4>
    <p>æ–°éƒæ–°å©¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆFirebase Authenticationã‚’ä½¿ç”¨ï¼‰</p>

    <h4>GET /api/auth/guestToken</h4>
    <p>ã‚²ã‚¹ãƒˆç”¨ä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ</p>
    <ul>
        <li>Query: eventId, qrToken</li>
        <li>Response: {sessionToken, expiresAt}</li>
    </ul>

    <h3>4.2 ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</h3>
    <h4>POST /api/events/create</h4>
    <p>ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ</p>
    <pre>Request:
{
  "eventName": "å±±ç”°å¤ªéƒ &amp; èŠ±å­ çµå©šå¼",
  "eventDate": "2025-01-25",
  "eventLocation": "æ±äº¬ã‚¬ãƒ¼ãƒ‡ãƒ³ãƒ‘ãƒ¬ã‚¹",
  "guestLimit": 100,
  "autoPublish": true,
  "publishTime": "09:00"
}

Response:
{
  "success": true,
  "eventId": "evt_abc123",
  "qrCodeUrl": "https://storage.../qr_evt_abc123.png",
  "qrToken": "qr_secret_token"
}</pre>

    <h4>GET /api/events/:eventId</h4>
    <p>ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°å–å¾—</p>

    <h4>PATCH /api/events/:eventId</h4>
    <p>ã‚¤ãƒ™ãƒ³ãƒˆæ›´æ–°</p>

    <h4>DELETE /api/events/:eventId</h4>
    <p>ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰</p>

    <h4>POST /api/events/:eventId/publishPhotos</h4>
    <p>å†™çœŸä¸€æ‹¬å…¬é–‹</p>

    <h3>4.3 å†™çœŸç®¡ç†</h3>
    <h4>POST /api/photos/upload</h4>
    <p>å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
    <ul>
        <li>Multipart form-data</li>
        <li>Max file size: 10MB</li>
        <li>Allowed formats: jpg, png, heic</li>
        <li>Response: {photoId, urls: {original, thumbnail, medium}}</li>
    </ul>

    <h4>GET /api/photos/list</h4>
    <p>å†™çœŸä¸€è¦§å–å¾—</p>
    <ul>
        <li>Query: eventId, isPublished, limit, offset</li>
        <li>Response: {photos: [], total, hasMore}</li>
    </ul>

    <h4>DELETE /api/photos/:photoId</h4>
    <p>å†™çœŸå‰Šé™¤</p>

    <h4>POST /api/photos/:eventId/download</h4>
    <p>ã‚¢ãƒ«ãƒãƒ ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆZIPç”Ÿæˆï¼‰</p>
    <ul>
        <li>Response: {downloadUrl, expiresAt}</li>
    </ul>

    <h3>4.4 ã‚°ãƒƒã‚ºãƒ»æ³¨æ–‡</h3>
    <h4>GET /api/products/list</h4>
    <p>å•†å“ä¸€è¦§å–å¾—</p>
    <ul>
        <li>Query: category, isActive</li>
        <li>Response: {products: []}</li>
    </ul>

    <h4>GET /api/products/:productId</h4>
    <p>å•†å“è©³ç´°</p>

    <h4>POST /api/orders/create</h4>
    <p>æ³¨æ–‡ä½œæˆ</p>
    <pre>Request:
{
  "eventId": "evt_abc123",
  "items": [{
    "productId": "prod_001",
    "quantity": 2,
    "selectedOptions": [{"optionId": "size", "value": "A4"}]
  }],
  "shippingInfo": {
    "name": "å±±ç”°å¤ªéƒ",
    "email": "<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6d140c000c090c2d08150c001d0108430e0200">[email&#160;protected]</a>",
    "phone": "090-1234-5678",
    "postalCode": "100-0001",
    "prefecture": "æ±äº¬éƒ½",
    "city": "åƒä»£ç”°åŒº",
    "address1": "åƒä»£ç”°1-1-1",
    "address2": "ãƒãƒ³ã‚·ãƒ§ãƒ³101"
  }
}

Response:
{
  "success": true,
  "orderId": "order_789",
  "clientSecret": "pi_xxx_secret_yyy" // Stripe PaymentIntent
}</pre>

    <h4>POST /api/orders/:orderId/confirm</h4>
    <p>æ³¨æ–‡ç¢ºå®šï¼ˆæ±ºæ¸ˆæˆåŠŸå¾Œï¼‰</p>

    <h4>GET /api/orders/:orderId</h4>
    <p>æ³¨æ–‡è©³ç´°å–å¾—</p>

    <h4>PATCH /api/orders/:orderId/updateStatus</h4>
    <p>æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</p>

    <h3>4.5 Webhook</h3>
    <h4>POST /api/webhooks/stripe</h4>
    <p>Stripe Webhookå‡¦ç†</p>
    <ul>
        <li>ã‚¤ãƒ™ãƒ³ãƒˆ: payment_intent.succeeded</li>
        <li>å‡¦ç†: æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡</li>
    </ul>

    <h2>5. iOS Appå®Ÿè£…è©³ç´°ï¼ˆSwiftUIï¼‰</h2>

    <h3>5.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ </h3>
    <pre>WeddingMoments/
â”œâ”€â”€ WeddingMomentsApp.swift
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ Event.swift
â”‚   â”œâ”€â”€ Photo.swift
â”‚   â”œâ”€â”€ Product.swift
â”‚   â””â”€â”€ Order.swift
â”œâ”€â”€ ViewModels/
â”‚   â”œâ”€â”€ AuthViewModel.swift
â”‚   â”œâ”€â”€ EventViewModel.swift
â”‚   â”œâ”€â”€ PhotoViewModel.swift
â”‚   â””â”€â”€ ShopViewModel.swift
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ Auth/
â”‚   â”‚   â”œâ”€â”€ SignInView.swift
â”‚   â”‚   â””â”€â”€ SignUpView.swift
â”‚   â”œâ”€â”€ Event/
â”‚   â”‚   â”œâ”€â”€ EventListView.swift
â”‚   â”‚   â”œâ”€â”€ EventDetailView.swift
â”‚   â”‚   â”œâ”€â”€ CreateEventView.swift
â”‚   â”‚   â””â”€â”€ QRCodeView.swift
â”‚   â”œâ”€â”€ Photo/
â”‚   â”‚   â”œâ”€â”€ PhotoGridView.swift
â”‚   â”‚   â”œâ”€â”€ CameraView.swift
â”‚   â”‚   â””â”€â”€ PhotoDetailView.swift
â”‚   â””â”€â”€ Shop/
â”‚       â”œâ”€â”€ ProductListView.swift
â”‚       â”œâ”€â”€ ProductDetailView.swift
â”‚       â”œâ”€â”€ CartView.swift
â”‚       â””â”€â”€ CheckoutView.swift
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ FirebaseService.swift
â”‚   â”œâ”€â”€ StorageService.swift
â”‚   â”œâ”€â”€ StripeService.swift
â”‚   â””â”€â”€ NotificationService.swift
â””â”€â”€ Utilities/
    â”œâ”€â”€ Constants.swift
    â”œâ”€â”€ Extensions.swift
    â””â”€â”€ ImagePicker.swift</pre>

    <h3>5.2 ä¸»è¦ã‚³ãƒ¼ãƒ‰ä¾‹</h3>

    <h4>Event.swift - ãƒ¢ãƒ‡ãƒ«å®šç¾©</h4>
    <pre>import Foundation
import FirebaseFirestore

struct Event: Identifiable, Codable {
    @DocumentID var id: String?
    var eventId: String { id ?? "" }
    var hostUserId: String
    var eventName: String
    var eventDate: String
    var eventLocation: String?
    var qrToken: String
    var qrCodeUrl: String
    var guestLimit: Int
    var currentGuestCount: Int
    var status: EventStatus
    var photosPublishedAt: Timestamp?
    var autoPublish: Bool
    var publishTime: String
    var settings: EventSettings
    var subscriptionTier: SubscriptionTier
    var createdAt: Timestamp
    var updatedAt: Timestamp
    
    enum EventStatus: String, Codable {
        case draft, active, ended, archived
    }
    
    enum SubscriptionTier: String, Codable {
        case basic, standard, premium
    }
    
    struct EventSettings: Codable {
        var allowGuestDownload: Bool
        var watermark: Bool
        var compressionQuality: Double
    }
}</pre>

    <div class="success">
        <p><strong>âœ… å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆï¼š</strong></p>
        <ul>
            <li>Firebase DocumentIDã‚’ä½¿ç”¨ã—ã¦AutoIDã‚’å®Ÿç¾</li>
            <li>Enumã‚’æ´»ç”¨ã—ã¦ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ãªã‚³ãƒ¼ãƒ‰å®Ÿè£…</li>
            <li>Nested structã§JSONãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ­£ç¢ºã«åæ˜ </li>
        </ul>
    </div>

    <h4>EventViewModel.swift</h4>
    <pre>import Foundation
import FirebaseFirestore
import FirebaseAuth
import Combine

@MainActor
class EventViewModel: ObservableObject {
    @Published var events: [Event] = []
    @Published var currentEvent: Event?
    @Published var isLoading = false
    @Published var errorMessage: String?
    
    private let db = Firestore.firestore()
    private var listener: ListenerRegistration?
    
    func fetchEvents() async {
        isLoading = true
        defer { isLoading = false }
        
        guard let userId = Auth.auth().currentUser?.uid else {
            errorMessage = "èªè¨¼ãŒå¿…è¦ã§ã™"
            return
        }
        
        do {
            let snapshot = try await db.collection("events")
                .whereField("hostUserId", isEqualTo: userId)
                .order(by: "eventDate", descending: true)
                .getDocuments()
            
            events = snapshot.documents.compactMap { doc in
                try? doc.data(as: Event.self)
            }
        } catch {
            errorMessage = "ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: \(error.localizedDescription)"
        }
    }
    
    func createEvent(name: String, date: Date, location: String?, guestLimit: Int) async -&gt; Bool {
        isLoading = true
        defer { isLoading = false }
        
        guard let userId = Auth.auth().currentUser?.uid else {
            errorMessage = "èªè¨¼ãŒå¿…è¦ã§ã™"
            return false
        }
        
        // Firebase Functionã‚’å‘¼ã³å‡ºã™
        do {
            let functions = Functions.functions()
            let data: [String: Any] = [
                "eventName": name,
                "eventDate": ISO8601DateFormatter().string(from: date),
                "eventLocation": location ?? "",
                "guestLimit": guestLimit,
                "autoPublish": true,
                "publishTime": "09:00"
            ]
            
            let result = try await functions.httpsCallable("createEvent").call(data)
            if let response = result.data as? [String: Any],
               let success = response["success"] as? Bool, success {
                await fetchEvents()
                return true
            }
        } catch {
            errorMessage = "ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: \(error.localizedDescription)"
        }
        
        return false
    }
    
    func listenToEvent(eventId: String) {
        listener?.remove()
        listener = db.collection("events").document(eventId)
            .addSnapshotListener { [weak self] snapshot, error in
                guard let self = self else { return }
                if let error = error {
                    self.errorMessage = "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼: \(error.localizedDescription)"
                    return
                }
                
                if let snapshot = snapshot {
                    self.currentEvent = try? snapshot.data(as: Event.self)
                }
            }
    }
    
    deinit {
        listener?.remove()
    }
}</pre>

    <div class="highlight">
        <p><strong>âš ï¸ é‡è¦ãªå®Ÿè£…ãƒã‚¤ãƒ³ãƒˆï¼š</strong></p>
        <ul>
            <li>@MainActorã‚’ä½¿ç”¨ã—ã¦UIæ›´æ–°ã‚’é©åˆ‡ã«å‡¦ç†</li>
            <li>async/awaitã¨Combineã‚’ä½µç”¨ã—ãŸãƒ¢ãƒ€ãƒ³ãªéåŒæœŸå‡¦ç†</li>
            <li>é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</li>
            <li>ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ããŸã‚ã®Listeneré©åˆ‡ãªè§£æ”¾</li>
        </ul>
    </div>

    <h4>QRCodeView.swift</h4>
    <pre>import SwiftUI
import CoreImage.CIFilterBuiltins

struct QRCodeView: View {
    let event: Event
    @State private var qrImage: UIImage?
    
    var body: some View {
        VStack(spacing: 20) {
            Text(event.eventName)
                .font(.title)
                .bold()
            
            if let qrImage = qrImage {
                Image(uiImage: qrImage)
                    .interpolation(.none)
                    .resizable()
                    .scaledToFit()
                    .frame(width: 300, height: 300)
            } else {
                ProgressView()
                    .frame(width: 300, height: 300)
            }
            
            Text("ã‚²ã‚¹ãƒˆã¯ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å‚åŠ ã§ãã¾ã™")
                .font(.caption)
                .foregroundColor(.secondary)
                .multilineTextAlignment(.center)
            
            ShareLink(item: Image(uiImage: qrImage ?? UIImage()), preview: SharePreview("QRã‚³ãƒ¼ãƒ‰")) {
                Label("QRã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰", systemImage: "square.and.arrow.up")
                    .frame(maxWidth: .infinity)
            }
            .buttonStyle(.borderedProminent)
        }
        .padding()
        .onAppear {
            generateQRCode()
        }
    }
    
    private func generateQRCode() {
        let guestUrl = "https://weddingmoments.app/join/\(event.eventId)?token=\(event.qrToken)"
        
        let context = CIContext()
        let filter = CIFilter.qrCodeGenerator()
        filter.message = Data(guestUrl.utf8)
        filter.correctionLevel = "H"
        
        if let outputImage = filter.outputImage,
           let cgImage = context.createCGImage(outputImage, from: outputImage.extent) {
            qrImage = UIImage(cgImage: cgImage)
        }
    }
}</pre>

    <h2>6. Web Appå®Ÿè£…ï¼ˆNext.js/Reactï¼‰</h2>

    <h3>6.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ </h3>
    <pre>wedding-moments-web/
â”œâ”€â”€ public/
â”‚   â””â”€â”€ manifest.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ join/[eventId]/page.tsx
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ Camera.tsx
â”‚   â”‚   â”œâ”€â”€ PhotoGallery.tsx
â”‚   â”‚   â””â”€â”€ UploadButton.tsx
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ firebase.ts
â”‚   â”‚   â””â”€â”€ api.ts
â”‚   â””â”€â”€ hooks/
â”‚       â”œâ”€â”€ useAuth.ts
â”‚       â””â”€â”€ usePhotos.ts
â”œâ”€â”€ next.config.js
â””â”€â”€ package.json</pre>

    <h3>6.2 ä¸»è¦ã‚³ãƒ¼ãƒ‰ä¾‹</h3>

    <h4>join/[eventId]/page.tsx - ã‚²ã‚¹ãƒˆå‚åŠ ãƒšãƒ¼ã‚¸</h4>
    <pre>'use client';

import { useEffect, useState } from 'react';
import { useParams, useSearchParams } from 'next/navigation';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, query, where, onSnapshot } from 'firebase/firestore';
import Camera from '@/components/Camera';
import PhotoGallery from '@/components/PhotoGallery';

export default function JoinEventPage() {
  const params = useParams();
  const searchParams = useSearchParams();
  const eventId = params.eventId as string;
  const qrToken = searchParams.get('token');
  
  const [event, setEvent] = useState<any>(null);
  const [photos, setPhotos] = useState<any[]>([]);
  const [sessionToken, setSessionToken] = useState<string |="" null="">(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() =&gt; {
    if (!eventId || !qrToken) return;
    
    // ã‚²ã‚¹ãƒˆãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
    fetch(`/api/auth/guestToken?eventId=${eventId}&amp;qrToken=${qrToken}`)
      .then(res =&gt; res.json())
      .then(data =&gt; {
        if (data.sessionToken) {
          setSessionToken(data.sessionToken);
          localStorage.setItem('guestToken', data.sessionToken);
          fetchEvent();
        }
      })
      .catch(err =&gt; {
        console.error('ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        setLoading(false);
      });
  }, [eventId, qrToken]);
  
  useEffect(() =&gt; {
    if (!eventId || !sessionToken) return;
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å†™çœŸè³¼èª­
    const db = getFirestore();
    const q = query(
      collection(db, 'photos'),
      where('eventId', '==', eventId),
      where('isPublished', '==', true)
    );
    
    const unsubscribe = onSnapshot(q, (snapshot) =&gt; {
      const newPhotos = snapshot.docs.map(doc =&gt; ({
        id: doc.id,
        ...doc.data()
      }));
      setPhotos(newPhotos);
    });
    
    return () =&gt; unsubscribe();
  }, [eventId, sessionToken]);
  
  const fetchEvent = async () =&gt; {
    try {
      const res = await fetch(`/api/events/${eventId}`, {
        headers: {
          'Authorization': `Bearer ${sessionToken}`
        }
      });
      const data = await res.json();
      setEvent(data);
    } catch (err) {
      console.error('ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    } finally {
      setLoading(false);
    }
  };
  
  const handlePhotoUpload = async (file: File) =&gt; {
    if (!sessionToken) return;
    
    const formData = new FormData();
    formData.append('photo', file);
    formData.append('eventId', eventId);
    formData.append('sessionToken', sessionToken);
    
    try {
      const res = await fetch('/api/photos/upload', {
        method: 'POST',
        body: formData
      });
      
      if (res.ok) {
        alert('å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
      }
    } catch (err) {
      console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', err);
      alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };
  
  if (loading) {
    return <div classname="flex items-center justify-center h-screen">èª­ã¿è¾¼ã¿ä¸­...</div>;
  }
  
  if (!event) {
    return <div classname="flex items-center justify-center h-screen">ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }
  
  return (
    <div classname="min-h-screen bg-gray-50">
      <header classname="bg-white shadow">
        <div classname="max-w-7xl mx-auto py-4 px-4">
          <h1 classname="text-2xl font-bold text-gray-900">{event.eventName}</h1>
          <p classname="text-sm text-gray-500">{new Date(event.eventDate).toLocaleDateString('ja-JP')}</p>
        </div>
      </header>
      
      <main classname="max-w-7xl mx-auto py-6 px-4">
        <camera oncapture="{handlePhotoUpload}">
        
        <div classname="mt-8">
          <h2 classname="text-xl font-semibold mb-4">ã¿ã‚“ãªã®å†™çœŸ</h2>
          <photogallery photos="{photos}">
        </photogallery></div>
      </camera></main>
    </div>
  );
}</string></any[]></any></pre>

    <h4>components/Camera.tsx</h4>
    <pre>'use client';

import { useRef, useState, useCallback } from 'react';

interface CameraProps {
  onCapture: (file: File) =&gt; void;
}

export default function Camera({ onCapture }: CameraProps) {
  const fileInputRef = useRef<htmlinputelement>(null);
  const [preview, setPreview] = useState<string |="" null="">(null);
  
  const handleFileChange = useCallback((e: React.ChangeEvent<htmlinputelement>) =&gt; {
    const file = e.target.files?.[0];
    if (!file) return;
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    const reader = new FileReader();
    reader.onload = (e) =&gt; {
      setPreview(e.target?.result as string);
    };
    reader.readAsDataURL(file);
    
    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    onCapture(file);
    
    // ãƒªã‚»ãƒƒãƒˆ
    setTimeout(() =&gt; {
      setPreview(null);
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    }, 2000);
  }, [onCapture]);
  
  return (
    <div classname="bg-white rounded-lg shadow p-6">
      <input ref="{fileInputRef}" type="file" accept="image/*" capture="environment" onchange="{handleFileChange}" classname="hidden">
      
      <button onclick="{()" ==""> fileInputRef.current?.click()}
        className="w-full bg-blue-600 text-white py-4 px-6 rounded-lg font-semibold hover:bg-blue-700 transition"
      &gt;
        ğŸ“· å†™çœŸã‚’æ’®ã‚‹
      </button>
      
      {preview &amp;&amp; (
        <div classname="mt-4">
          <img src="{preview}" alt="Preview" classname="w-full rounded-lg" data-height-listener-added="true">
          <p classname="text-center text-sm text-gray-500 mt-2">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
        </div>
      )}
    </div>
  );
}</htmlinputelement></string></htmlinputelement></pre>

    <h2>7. Firebase Functionså®Ÿè£…</h2>

    <h3>7.1 functions/src/index.ts</h3>
    <pre>import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import Stripe from 'stripe';

admin.initializeApp();
const db = admin.firestore();
const stripe = new Stripe(functions.config().stripe.secret_key, {
  apiVersion: '2023-10-16'
});

// ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
export const createEvent = functions.https.onCall(async (data, context) =&gt; {
  if (!context.auth) {
    throw new functions.https.HttpsError('unauthenticated', 'èªè¨¼ãŒå¿…è¦ã§ã™');
  }
  
  const { eventName, eventDate, eventLocation, guestLimit, autoPublish, publishTime } = data;
  
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!eventName || !eventDate || !guestLimit) {
    throw new functions.https.HttpsError('invalid-argument', 'å¿…é ˆé …ç›®ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
  }
  
  // QRãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
  const qrToken = generateSecureToken();
  
  // ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
  const eventRef = db.collection('events').doc();
  const eventData = {
    eventId: eventRef.id,
    hostUserId: context.auth.uid,
    eventName,
    eventDate,
    eventLocation: eventLocation || null,
    qrToken,
    qrCodeUrl: '', // å¾Œã§QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ç”Ÿæˆ
    guestLimit,
    currentGuestCount: 0,
    status: 'active',
    photosPublishedAt: null,
    autoPublish,
    publishTime,
    settings: {
      allowGuestDownload: true,
      watermark: false,
      compressionQuality: 0.8
    },
    subscriptionTier: 'basic',
    stripeSubscriptionId: null,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
  };
  
  await eventRef.set(eventData);
  
  // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆåˆ¥ã®Functionã¾ãŸã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼‰
  const qrCodeUrl = await generateQRCode(eventRef.id, qrToken);
  await eventRef.update({ qrCodeUrl });
  
  return {
    success: true,
    eventId: eventRef.id,
    qrCodeUrl,
    qrToken
  };
});

// ã‚²ã‚¹ãƒˆãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ
export const getGuestToken = functions.https.onRequest(async (req, res) =&gt; {
  const { eventId, qrToken } = req.query;
  
  if (!eventId || !qrToken) {
    res.status(400).json({ error: 'å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™' });
    return;
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆæ¤œè¨¼
  const eventDoc = await db.collection('events').doc(eventId as string).get();
  if (!eventDoc.exists) {
    res.status(404).json({ error: 'ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
    return;
  }
  
  const eventData = eventDoc.data();
  if (eventData?.qrToken !== qrToken) {
    res.status(401).json({ error: 'ç„¡åŠ¹ãªQRãƒˆãƒ¼ã‚¯ãƒ³ã§ã™' });
    return;
  }
  
  // ã‚²ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
  const sessionToken = generateSecureToken();
  const expiresAt = new Date();
  expiresAt.setDate(expiresAt.getDate() + 7); // 7æ—¥é–“æœ‰åŠ¹
  
  await db.collection('guestSessions').add({
    eventId: eventId as string,
    guestToken: sessionToken,
    deviceInfo: req.headers['user-agent'] || 'unknown',
    ipAddress: req.ip,
    expiresAt: admin.firestore.Timestamp.fromDate(expiresAt),
    lastAccessAt: admin.firestore.FieldValue.serverTimestamp(),
    createdAt: admin.firestore.FieldValue.serverTimestamp()
  });
  
  res.json({
    sessionToken,
    expiresAt: expiresAt.toISOString()
  });
});

// å†™çœŸè‡ªå‹•å…¬é–‹ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼‰
export const autoPublishPhotos = functions.pubsub.schedule('every 1 hours').onRun(async (context) =&gt; {
  const now = new Date();
  const todayDate = now.toISOString().split('T')[0];
  
  // ä»Šæ—¥ãŒå…¬é–‹æ—¥ã§ã€autoPublishãŒtrueã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
  const eventsSnapshot = await db.collection('events')
    .where('eventDate', '==', todayDate)
    .where('autoPublish', '==', true)
    .where('status', '==', 'active')
    .get();
  
  for (const doc of eventsSnapshot.docs) {
    const event = doc.data();
    const publishTime = event.publishTime || '09:00';
    const [hours, minutes] = publishTime.split(':').map(Number);
    
    if (now.getHours() === hours &amp;&amp; now.getMinutes() &gt;= minutes &amp;&amp; now.getMinutes() &lt; minutes + 60) {
      // å†™çœŸã‚’å…¬é–‹
      await publishEventPhotos(doc.id);
    }
  }
});

// Stripe Webhook
export const stripeWebhook = functions.https.onRequest(async (req, res) =&gt; {
  const sig = req.headers['stripe-signature'] as string;
  const webhookSecret = functions.config().stripe.webhook_secret;
  
  let event: Stripe.Event;
  
  try {
    event = stripe.webhooks.constructEvent(req.rawBody, sig, webhookSecret);
  } catch (err) {
    console.error('Webhook signature verification failed:', err);
    res.status(400).send(`Webhook Error: ${err}`);
    return;
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
  switch (event.type) {
    case 'payment_intent.succeeded':
      const paymentIntent = event.data.object as Stripe.PaymentIntent;
      await handlePaymentSuccess(paymentIntent);
      break;
      
    case 'payment_intent.payment_failed':
      const failedPayment = event.data.object as Stripe.PaymentIntent;
      await handlePaymentFailure(failedPayment);
      break;
  }
  
  res.json({ received: true });
});

// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function generateSecureToken(): string {
  return Math.random().toString(36).substring(2) + Date.now().toString(36);
}

async function generateQRCode(eventId: string, qrToken: string): Promise<string> {
  // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¾‹ï¼šqrcode npm packageä½¿ç”¨ï¼‰
  // ç”Ÿæˆã—ãŸQRã‚³ãƒ¼ãƒ‰ã‚’Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  // URLã‚’è¿”ã™
  return `https://storage.googleapis.com/.../qr_${eventId}.png`;
}</string></pre>

    <h2>8. Stripeæ±ºæ¸ˆå®Ÿè£…</h2>

    <h3>8.1 iOSå´ï¼ˆCheckoutView.swiftï¼‰</h3>
    <pre>import SwiftUI
import Stripe

struct CheckoutView: View {
    let order: Order
    @StateObject private var paymentService = StripePaymentService()
    @State private var paymentSheet: PaymentSheet?
    @State private var isProcessing = false
    
    var body: some View {
        VStack(spacing: 20) {
            Text("ãŠæ”¯æ‰•ã„")
                .font(.title)
                .bold()
            
            // æ³¨æ–‡ã‚µãƒãƒªãƒ¼
            OrderSummaryView(order: order)
            
            Button {
                Task {
                    await processPayment()
                }
            } label: {
                if isProcessing {
                    ProgressView()
                        .tint(.white)
                } else {
                    Text("Â¥\(order.amounts.total) ã‚’æ”¯æ‰•ã†")
                }
            }
            .frame(maxWidth: .infinity)
            .padding()
            .background(Color.blue)
            .foregroundColor(.white)
            .cornerRadius(10)
            .disabled(isProcessing)
        }
        .padding()
    }
    
    private func processPayment() async {
        isProcessing = true
        defer { isProcessing = false }
        
        do {
            // PaymentIntentã‚’ä½œæˆ
            let clientSecret = try await paymentService.createPaymentIntent(
                amount: order.amounts.total,
                orderId: order.orderId
            )
            
            // Payment Sheetã‚’è¡¨ç¤º
            let configuration = PaymentSheet.Configuration()
            configuration.merchantDisplayName = "WeddingMoments"
            
            paymentSheet = PaymentSheet(
                paymentIntentClientSecret: clientSecret,
                configuration: configuration
            )
            
            // æ±ºæ¸ˆå‡¦ç†
            if let sheet = paymentSheet {
                let result = await sheet.present()
                
                switch result {
                case .completed:
                    // æˆåŠŸ
                    showSuccessAlert()
                case .canceled:
                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    break
                case .failed(let error):
                    // ã‚¨ãƒ©ãƒ¼
                    showErrorAlert(error.localizedDescription)
                }
            }
        } catch {
            showErrorAlert(error.localizedDescription)
        }
    }
}</pre>

    <h2>9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</h2>

    <h3>9.1 èªè¨¼ãƒ»èªå¯</h3>
    <ul>
        <li>Firebase Authenticationã‚’ä½¿ç”¨</li>
        <li>ã‚²ã‚¹ãƒˆã¯ä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆJWTï¼‰ã§èªè¨¼</li>
        <li>Firestore Security Rulesã§å³æ ¼ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡</li>
    </ul>

    <h3>9.2 ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–</h3>
    <ul>
        <li>Firebase Storageã¯è‡ªå‹•çš„ã«æš—å·åŒ–</li>
        <li>æ©Ÿå¯†æƒ…å ±ï¼ˆé…é€å…ˆç­‰ï¼‰ã¯AES-256ã§æš—å·åŒ–ã—ã¦Firestoreã«ä¿å­˜</li>
        <li>HTTPSé€šä¿¡ã‚’å¼·åˆ¶</li>
    </ul>

    <h3>9.3 QRãƒˆãƒ¼ã‚¯ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
    <pre>import * as crypto from 'crypto';

function generateSecureQRToken(): string {
  return crypto.randomBytes(32).toString('hex');
}

function validateQRToken(eventId: string, token: string): boolean {
  // ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
  // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ã€ä½¿ç”¨å›æ•°åˆ¶é™ç­‰
  return true;
}</pre>

    <h2>10. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</h2>

    <h3>10.1 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼</h3>
    <pre>enum NetworkError: Error {
    case noConnection
    case timeout
    case serverError(Int)
    case invalidResponse
    
    var localizedDescription: String {
        switch self {
        case .noConnection:
            return "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        case .timeout:
            return "æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
        case .serverError(let code):
            return "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆ\(code)ï¼‰"
        case .invalidResponse:
            return "ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã™"
        }
    }
}</pre>

    <h2>11. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</h2>

    <h3>11.1 ç”»åƒåœ§ç¸®</h3>
    <pre>extension UIImage {
    func compressed(quality: CGFloat = 0.8, maxSize: CGSize = CGSize(width: 1920, height: 1920)) -&gt; UIImage? {
        // ãƒªã‚µã‚¤ã‚º
        let aspectRatio = size.width / size.height
        var targetSize = maxSize
        
        if size.width &gt; maxSize.width || size.height &gt; maxSize.height {
            if aspectRatio &gt; 1 {
                targetSize.height = maxSize.width / aspectRatio
            } else {
                targetSize.width = maxSize.height * aspectRatio
            }
        } else {
            targetSize = size
        }
        
        let renderer = UIGraphicsImageRenderer(size: targetSize)
        let resized = renderer.image { _ in
            self.draw(in: CGRect(origin: .zero, size: targetSize))
        }
        
        // åœ§ç¸®
        return resized.jpegData(compressionQuality: quality).flatMap { UIImage(data: $0) }
    }
}</pre>

    <h2>12. ãƒ†ã‚¹ãƒˆè¨ˆç”»</h2>

    <h3>12.1 Unit Testsï¼ˆXCTestï¼‰</h3>
    <pre>import XCTest
@testable import WeddingMoments

class EventViewModelTests: XCTestCase {
    var viewModel: EventViewModel!
    
    override func setUp() {
        super.setUp()
        viewModel = EventViewModel()
    }
    
    func testCreateEvent() async {
        let success = await viewModel.createEvent(
            name: "Test Event",
            date: Date(),
            location: "Test Location",
            guestLimit: 50
        )
        
        XCTAssertTrue(success)
        XCTAssertFalse(viewModel.events.isEmpty)
    }
}</pre>

    <h2>13. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †</h2>

    <h3>13.1 iOS Appï¼ˆApp Storeï¼‰</h3>
    <ol>
        <li><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†</strong>
            <ul>
                <li>Xcode &gt; General &gt; Version &amp; Build Numberæ›´æ–°</li>
                <li>Git tagä½œæˆ: <code>git tag v1.0.0</code></li>
            </ul>
        </li>
        <li><strong>Archiveä½œæˆ</strong>
            <ul>
                <li>Xcode &gt; Product &gt; Archive</li>
                <li>Organizer &gt; Distribute App</li>
            </ul>
        </li>
        <li><strong>App Store Connect</strong>
            <ul>
                <li>ã‚¢ãƒ—ãƒªæƒ…å ±å…¥åŠ›</li>
                <li>ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆè¿½åŠ </li>
                <li>å¯©æŸ»ã«æå‡º</li>
            </ul>
        </li>
    </ol>

    <h3>13.2 Firebase Functions</h3>
    <pre># ãƒ‡ãƒ—ãƒ­ã‚¤
firebase deploy --only functions

# ç‰¹å®šã®é–¢æ•°ã®ã¿
firebase deploy --only functions:createEvent,functions:stripeWebhook

# æœ¬ç•ªç’°å¢ƒè¨­å®š
firebase functions:config:set stripe.secret_key="sk_live_..."
firebase functions:config:set stripe.webhook_secret="whsec_..."</pre>

    <h2>14. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒ­ã‚°</h2>

    <h3>14.1 Firebase Crashlyticsï¼ˆiOSï¼‰</h3>
    <pre>import FirebaseCrashlytics

// ã‚¨ãƒ©ãƒ¼è¨˜éŒ²
Crashlytics.crashlytics().record(error: error)

// ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚°
Crashlytics.crashlytics().log("User uploaded photo: \(photoId)")

// ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¨­å®š
Crashlytics.crashlytics().setUserID(userId)</pre>

    <h2>15. é‹ç”¨ãƒ»ä¿å®ˆ</h2>

    <h3>15.1 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥</h3>
    <ul>
        <li>Firestore: è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æœ‰åŠ¹åŒ–ï¼ˆFirebase Consoleï¼‰</li>
        <li>Storage: ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹åŒ–</li>
        <li>å®šæœŸçš„ãªã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆé€±æ¬¡ï¼‰</li>
    </ul>

    <h3>15.2 ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆè¨ˆç”»</h3>
    <ul>
        <li><strong>Phase 1ï¼ˆãƒªãƒªãƒ¼ã‚¹ç›´å¾Œï¼‰ï¼š</strong>ãƒã‚°ä¿®æ­£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„</li>
        <li><strong>Phase 2ï¼ˆ1-2ãƒ¶æœˆå¾Œï¼‰ï¼š</strong>å‹•ç”»å¯¾å¿œã€å†™çœŸç·¨é›†æ©Ÿèƒ½</li>
        <li><strong>Phase 3ï¼ˆ3-4ãƒ¶æœˆå¾Œï¼‰ï¼š</strong>Androidç‰ˆãƒªãƒªãƒ¼ã‚¹</li>
        <li><strong>Phase 4ï¼ˆ6ãƒ¶æœˆå¾Œï¼‰ï¼š</strong>AIè‡ªå‹•ã‚¢ãƒ«ãƒãƒ ä½œæˆ</li>
    </ul>

    <h2>16. ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š</h2>

    <h3>16.1 åˆæœŸé–‹ç™ºã‚³ã‚¹ãƒˆï¼ˆ6é€±é–“ï¼‰</h3>
    <table>
        <tbody><tr>
            <th>é …ç›®</th>
            <th>é‡‘é¡</th>
            <th>å‚™è€ƒ</th>
        </tr>
        <tr>
            <td>Apple Developer</td>
            <td>Â¥12,980/å¹´</td>
            <td>å¿…é ˆ</td>
        </tr>
        <tr>
            <td>Firebase</td>
            <td>Â¥0</td>
            <td>Spark Plan â†’ å¾Œã§Blaze Plan</td>
        </tr>
        <tr>
            <td>Stripe</td>
            <td>æ±ºæ¸ˆæ‰‹æ•°æ–™ã®ã¿</td>
            <td>3.6%</td>
        </tr>
        <tr>
            <td>ãƒ‰ãƒ¡ã‚¤ãƒ³</td>
            <td>Â¥1,000/å¹´</td>
            <td>.app ãƒ‰ãƒ¡ã‚¤ãƒ³æ¨å¥¨</td>
        </tr>
        <tr>
            <th>åˆè¨ˆ</th>
            <th>ç´„Â¥14,000</th>
            <th>åˆæœŸè²»ç”¨</th>
        </tr>
    </tbody></table>

    <h3>16.2 æœˆé–“é‹ç”¨ã‚³ã‚¹ãƒˆï¼ˆæƒ³å®š100ã‚¤ãƒ™ãƒ³ãƒˆ/æœˆï¼‰</h3>
    <table>
        <tbody><tr>
            <th>ã‚µãƒ¼ãƒ“ã‚¹</th>
            <th>æœˆé¡</th>
            <th>å‚™è€ƒ</th>
        </tr>
        <tr>
            <td>Firebase Blaze Plan</td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>ã€€- Firestore</td>
            <td>Â¥5,000</td>
            <td>èª­ã¿æ›¸ããƒ»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</td>
        </tr>
        <tr>
            <td>ã€€- Storage</td>
            <td>Â¥10,000</td>
            <td>ç”»åƒä¿å­˜ãƒ»å¸¯åŸŸ</td>
        </tr>
        <tr>
            <td>ã€€- Functions</td>
            <td>Â¥3,000</td>
            <td>å®Ÿè¡Œæ™‚é–“ãƒ»å‘¼ã³å‡ºã—</td>
        </tr>
        <tr>
            <td>ã€€- Hosting</td>
            <td>Â¥1,000</td>
            <td>Webé…ä¿¡</td>
        </tr>
        <tr>
            <td>SendGrid</td>
            <td>Â¥0</td>
            <td>Free Plan</td>
        </tr>
        <tr>
            <td>ImageKit/Cloudinary</td>
            <td>Â¥5,000</td>
            <td>CDNãƒ»ç”»åƒå‡¦ç†</td>
        </tr>
        <tr>
            <th>åˆè¨ˆ</th>
            <th>ç´„Â¥24,000/æœˆ</th>
            <th>é‹ç”¨è²»ç”¨</th>
        </tr>
    </tbody></table><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script></body></html>